# TrendReader 问题修复说明

## 问题1: GitHub Actions 没有自动执行

### 原因分析
项目使用了**7天试用期机制**。查看 `.github/workflows/crawler.yml` 文件,发现:
- 每个运行周期为7天
- 7天期满后workflow会自动禁用
- 需要手动签到续期

### 解决方法
进入你的GitHub仓库,执行以下步骤:
1. 点击顶部的 **Actions** 标签
2. 在左侧找到 **Check In** workflow
3. 点击右侧的 **Run workflow** 按钮
4. 选择分支后,点击绿色的 **Run workflow** 按钮

**注意**: 需要每7天至少执行一次Check In,否则会自动停止。

### 长期解决方案
如果不想频繁签到,建议使用Docker部署方式,不受此限制。

---

## 问题2: 飞书消息不显示播客按钮

### 原因分析
播客按钮功能已实现(在 `trendradar/notification/senders.py` 中),但播客数据没有正确传递到飞书发送函数。

查看图一(有播客按钮)和图二(无播客按钮)的差异,发现:
- 图一显示了"🎙️ 热点播客"区域和"收听「xxx」播客"按钮
- 图二只有热点统计和新增新闻,缺少播客部分

### 问题根源
从代码流程追踪:
1. `__main__.py` 中调用 `_generate_podcasts()` 生成播客数据
2. 播客数据通过 `_send_notification_if_needed()` 传递
3. 最终通过 `NotificationDispatcher.dispatch_all()` 传递给飞书

但是,需要确保:
- ✅ 播客功能已启用(config.yaml中PODCAST.ENABLED = true)
- ✅ 配置了必要的API密钥(JINA_API_KEY, DEEPSEEK_API_KEY等)
- ✅ 播客生成成功并返回了有效的audio_url

### 解决步骤

#### 第1步: 检查播客配置

打开 `config/config.yaml`,确认播客配置:

```yaml
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 📻 播客生成配置 (Podcast Configuration)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
PODCAST:
  ENABLED: true  # 🔴 确保这里是 true

  # Jina AI 配置(拉取文章正文)
  JINA:
    API_KEY: ""  # 🔴 需要配置 Jina AI API Key
    API_URL: "https://r.jina.ai/"

  # LLM 配置(生成摘要)
  LLM:
    PROVIDER: "deepseek"  # 可选: openai, anthropic, deepseek
    API_KEY: ""  # 🔴 需要配置 DeepSeek API Key(或其他LLM的Key)
    MODEL: "deepseek-chat"
    API_URL: "https://api.deepseek.com/v1"

  # TTS 配置(音频生成)
  TTS:
    PROVIDER: "edge"  # 🔴 edge是免费的,不要修改
    VOICE: "zh-CN-XiaoxiaoNeural"  # Edge TTS 语音

  # 其他配置
  OUTPUT_DIR: "output/podcast"
  AUDIO_FORMAT: "mp3"
  MAX_ARTICLES_PER_KEYWORD: 5
  MAX_KEYWORDS: 3  # 限制生成播客的关键词数量
  FETCH_DELAY: 0.5
```

#### 第2步: 配置GitHub Secrets

如果使用GitHub Actions,需要添加以下Secrets:

进入仓库 → Settings → Secrets and variables → Actions → New repository secret

添加以下secrets:
- `JINA_API_KEY`: Jina AI的API密钥
- `DEEPSEEK_API_KEY`: DeepSeek的API密钥(或其他LLM的密钥)

**获取API密钥的方法:**

1. **Jina AI API Key** (免费):
   - 访问: https://jina.ai/
   - 注册账号并获取API Key
   
2. **DeepSeek API Key** (收费但便宜):
   - 访问: https://platform.deepseek.com/
   - 注册账号并充值(推荐充值10-20元即可使用很久)
   - 获取API Key

**注意**: `.github/workflows/crawler.yml` 已经配置好了环境变量映射(第166-168行),只需添加Secrets即可。

#### 第3步: 验证配置

手动触发一次Actions查看日志:
1. Actions → Get Hot News → Run workflow
2. 查看运行日志,搜索"播客"关键词
3. 应该能看到:
   ```
   🎙️ 开始生成热点播客
   📋 步骤 1/4: 提取关键词和文章...
   📖 步骤 2/4: 拉取文章正文...
   📝 步骤 3/4: 生成 AI 摘要...
   🎵 步骤 4/4: 生成播客音频...
   ```

#### 第4步: 确认音频上传成功

播客按钮需要有效的音频URL。代码中支持两种上传方式:
1. **S3存储**(优先): 如果配置了S3存储,音频会上传到你的S3桶
2. **Litterbox临时存储**(备用): 24小时有效的免费临时链接

查看日志确认上传成功:
```
✅ 「AI」音频生成成功: output/podcast/AI_20260204.mp3
📤 已上传到临时存储 (24h有效): https://litterbox.catbox.moe/xxx.mp3
```

---

## 完整的飞书消息结构

正确配置后,飞书消息应该包含以下部分:

1. **📊 热点词汇统计** (始终显示)
   - 各关键词匹配的新闻列表

2. **🆕 本次新增热点新闻** (始终显示)
   - 新出现的热点话题

3. **━━━━ 分隔线 ━━━━**

4. **🎙️ 热点播客** (需要podcast_data)
   - 收听「xxx」播客按钮
   - 收听「yyy」播客按钮
   - 💡 音频链接通常24小时内有效

---

## 调试技巧

### 查看播客是否生成
查看Actions运行日志,搜索"播客生成完成",应该看到:
```
🎙️ 播客生成完成: 3/3 成功
```

### 查看飞书是否收到播客数据
在日志中搜索"podcast_data",应该能看到传递了播客数据。

### 本地测试
如果想在本地测试:
```bash
# 设置环境变量
export JINA_API_KEY="your_jina_key"
export DEEPSEEK_API_KEY="your_deepseek_key"

# 运行
python -m trendradar
```

查看生成的音频文件:
```
output/podcast/
├── AI_20260204_193214.mp3
├── 特斯拉_20260204_193220.mp3
└── ...
```

---

## 常见问题

### Q1: 播客生成失败怎么办?
**A**: 查看日志中的错误信息:
- `❌ Jina API 调用失败`: 检查JINA_API_KEY是否正确
- `❌ 摘要生成失败`: 检查LLM API Key是否正确
- `❌ 音频生成失败`: Edge TTS是免费的,通常不会失败,检查网络

### Q2: 飞书只显示文本,没有按钮?
**A**: 可能的原因:
1. podcast_data为空或None
2. audio_url为空(上传失败)
3. 飞书webhook配置问题

检查方法:
- 查看Actions日志确认播客生成成功
- 确认日志中有"📤 已上传"的提示

### Q3: 按钮点击后无法播放?
**A**: 
- Litterbox临时链接24小时后会失效
- 如果使用S3存储,确保桶的访问权限设置为公开读取

### Q4: 不想每次都生成播客怎么办?
**A**: 修改config.yaml:
```yaml
PODCAST:
  ENABLED: false  # 关闭播客功能
```

---

## 代码修改说明

**注意**: 代码本身不需要修改,只需要配置即可。

已有的代码逻辑:
1. ✅ `__main__.py` 正确调用播客生成
2. ✅ `notification/dispatcher.py` 正确传递podcast_data到飞书
3. ✅ `notification/senders.py` 正确构建飞书卡片(包含按钮)

关键代码位置(无需修改,仅供参考):
- 播客生成: `trendradar/__main__.py` 第577-612行
- 飞书发送: `trendradar/notification/dispatcher.py` 第174-201行  
- 卡片构建: `trendradar/notification/senders.py` 第48-190行

---

## 总结

### 问题1解决方案
✅ 每7天手动运行一次"Check In" workflow续期

### 问题2解决方案
✅ 确保 `PODCAST.ENABLED = true`
✅ 配置 `JINA_API_KEY` 和 `DEEPSEEK_API_KEY`
✅ 确认播客生成成功并上传成功

配置完成后,飞书消息会自动包含播客按钮,无需修改代码。

---

如有问题,欢迎随时反馈! 🎉
