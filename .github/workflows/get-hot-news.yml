name: Get Hot News

on:
  schedule:
    # 每小时执行一次（GitHub Actions 使用 UTC 时间）
    - cron: "0 * * * *"
  workflow_dispatch: {}

concurrency:
  # 避免同一时间重复跑多个实例（例如手动触发+定时触发撞车）
  group: trendradar-get-hot-news
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run TrendRadar
        env:
          # 通知渠道（建议放 GitHub Secrets）
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          WEWORK_MSG_TYPE: ${{ secrets.WEWORK_MSG_TYPE }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          NTFY_SERVER_URL: ${{ secrets.NTFY_SERVER_URL }}
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
          BARK_URL: ${{ secrets.BARK_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

          # 远程存储（GitHub Actions 推荐）
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_ENDPOINT_URL: ${{ secrets.S3_ENDPOINT_URL }}
          S3_REGION: ${{ secrets.S3_REGION }}

          # 播客所需（按需配置 Secrets）
          JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          PODCAST_LLM_API_KEY: ${{ secrets.PODCAST_LLM_API_KEY }}

          # 其他可选覆盖（按需）
          REPORT_MODE: ${{ secrets.REPORT_MODE }}
          ENABLE_NOTIFICATION: ${{ secrets.ENABLE_NOTIFICATION }}
          ENABLE_CRAWLER: ${{ secrets.ENABLE_CRAWLER }}
          PUSH_WINDOW_ENABLED: ${{ secrets.PUSH_WINDOW_ENABLED }}
          PUSH_WINDOW_START: ${{ secrets.PUSH_WINDOW_START }}
          PUSH_WINDOW_END: ${{ secrets.PUSH_WINDOW_END }}
          PUSH_WINDOW_ONCE_PER_DAY: ${{ secrets.PUSH_WINDOW_ONCE_PER_DAY }}

        run: |
          python -m trendradar

